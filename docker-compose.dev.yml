# ========================================
# Docker Compose - Development Override
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# ========================================
# Note: 'version' field is obsolete in modern Docker Compose

services:
  # ========================================
  # PostgreSQL - Development Configuration
  # ========================================
  postgres:
    environment:
      # Development: UTF-8 encoding (locale handled by Alpine defaults)
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"

    # Development: Expose ports to host for direct access
    ports:
      - "5432:5432"

  # ========================================
  # Backend - Development Configuration
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      # Development: Disable build cache for fresh builds
      # cache_from: []

    environment:
      # Development Profile
      SPRING_PROFILES_ACTIVE: dev

      # Development: Enable debug logging
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_ANTIPANEL: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: DEBUG
      LOGGING_LEVEL_ORG_HIBERNATE_SQL: DEBUG
      LOGGING_LEVEL_ORG_HIBERNATE_TYPE_DESCRIPTOR_SQL_BASICBINDER: TRACE

      # Development: Show SQL queries
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "true"

      # Development: Auto-reload support (requires spring-boot-devtools)
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"

      # Development: CORS enabled for Angular frontend
      # Port 4200 = Angular dev server (ng serve / bun run start)
      # Port 3000 = Alternative dev server (future)
      APP_CORS_ALLOWED_ORIGINS: "http://localhost:4200,http://localhost:3000"

      # Development: Actuator endpoints
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "*"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always

      # Development: Add debug JVM options
      JAVA_OPTS: >-
        -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
        -XX:+UseContainerSupport
        -XX:MaxRAMPercentage=75.0
        -XX:+UseG1GC
        -Dspring.profiles.active=dev

    # Development: Mount source code for hot reload (optional)
    volumes:
      # Uncomment if using spring-boot-devtools
      # - ./backend/src:/app/src:ro

      # Logs volume for easy access
      - ./backend/logs:/app/logs

    # Development: Expose debug port
    ports:
      - "8080:8080"  # API Server
      - "5005:5005"  # Java Debug Port

    # Health check using Spring Boot Actuator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ========================================
  # Angular 21 Frontend - Development (Bun)
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development

    container_name: antipanel-frontend
    restart: unless-stopped

    environment:
      # Development environment
      NODE_ENV: development
      # API URL for backend communication
      API_URL: http://backend:8080/api
      # Enable polling for file changes (Docker volume compatibility)
      WATCHPACK_POLLING: "true"
      CHOKIDAR_USEPOLLING: "true"

    # Use host network to bypass Vite's host check in Docker
    network_mode: host

    # ports:
    #   - "4200:4200"  # Angular dev server (not needed with host network)

    volumes:
      # Hot reload - mount source code
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/angular.json:/app/angular.json
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/package.json:/app/package.json
      # Prevent node_modules from being overwritten by host mount
      - /app/node_modules
      - /app/.angular

    depends_on:
      - backend

    # networks: (not compatible with network_mode: host)
    #   - antipanel-network

    # Health check for frontend (using curl, more reliable than BusyBox wget)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:4200"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # pgAdmin - Database Management Tool (Optional)
  # ========================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: antipanel-pgadmin
    restart: unless-stopped

    environment:
      PGADMIN_DEFAULT_EMAIL: admin@antipanel.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: "False"

    ports:
      - "5050:80"

    volumes:
      - pgadmin_data:/var/lib/pgadmin

    networks:
      - antipanel-network

    depends_on:
      - postgres

# ========================================
# Development Volumes
# ========================================
volumes:
  pgadmin_data:
    driver: local

# ========================================
# Docker Compose - Development Override
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# ========================================
# Note: 'version' field is obsolete in modern Docker Compose

services:
  # ========================================
  # PostgreSQL - Development Configuration
  # ========================================
  postgres:
    # USE HOST NETWORK - bypasses Docker bridge networking issues
    network_mode: host

    # Override base config networks (mutually exclusive with network_mode)
    networks: !reset []

    environment:
      # Development: UTF-8 encoding (locale handled by Alpine defaults)
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"

  # ========================================
  # Backend - Development Configuration
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile

    # USE HOST NETWORK - bypasses Docker bridge networking issues on Linux Mint/Ubuntu
    network_mode: host

    # Override base config networks (mutually exclusive with network_mode)
    networks: !reset []

    environment:
      # Development Profile
      SPRING_PROFILES_ACTIVE: dev

      # Database: Use localhost since we're on host network (disable SSL for dev)
      SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/antipanel?sslmode=disable
      SPRING_DATASOURCE_USERNAME: antipanel_user
      SPRING_DATASOURCE_PASSWORD: antipanel_password

      # Development: Enable debug logging
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_ANTIPANEL: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: DEBUG
      LOGGING_LEVEL_ORG_HIBERNATE_SQL: DEBUG
      LOGGING_LEVEL_ORG_HIBERNATE_TYPE_DESCRIPTOR_SQL_BASICBINDER: TRACE

      # Development: Show SQL queries
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "true"

      # Development: Auto-update schema to match entities (prevents missing column errors)
      SPRING_JPA_HIBERNATE_DDL_AUTO: update

      # Development: Auto-reload support (requires spring-boot-devtools)
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"

      # Development: CORS enabled for Angular frontend
      APP_CORS_ALLOWED_ORIGINS: "http://localhost:4200,http://localhost:3000"

      # Development: Actuator endpoints
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "*"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always

      # Development: Add debug JVM options
      JAVA_OPTS: >-
        -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
        -XX:+UseContainerSupport
        -XX:MaxRAMPercentage=75.0
        -XX:+UseG1GC
        -Dspring.profiles.active=dev

    # Development: Mount logs volume
    volumes:
      - ./backend/logs:/app/logs

  # ========================================
  # Angular 21 Frontend - Development (Bun)
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development

    container_name: antipanel-frontend
    restart: unless-stopped

    # USE HOST NETWORK - bypasses Docker bridge networking issues on Linux Mint/Ubuntu
    # This allows direct access to localhost:4200 without port forwarding
    network_mode: host

    environment:
      # Development environment
      NODE_ENV: development
      # Enable polling for file changes (Docker volume compatibility)
      WATCHPACK_POLLING: "true"
      CHOKIDAR_USEPOLLING: "true"

    volumes:
      # Hot reload - mount source code
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/angular.json:/app/angular.json
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/package.json:/app/package.json
      # Prevent node_modules from being overwritten by host mount
      - /app/node_modules
      - /app/.angular

    depends_on:
      - backend

  # ========================================
  # pgAdmin - Database Management Tool (Optional)
  # ========================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: antipanel-pgadmin
    restart: unless-stopped

    # USE HOST NETWORK to match postgres (which is also on host network)
    network_mode: host

    # Override base config networks (incompatible with network_mode)
    networks: !reset []

    environment:
      # Use .com domain since .local is rejected by newer pgAdmin email validation
      PGADMIN_DEFAULT_EMAIL: admin@antipanel.dev
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: "False"
      # Set listen port since default 80 may conflict
      PGADMIN_LISTEN_PORT: 5050

    # ports: not needed with host network - access via localhost:5050

    volumes:
      - pgadmin_data:/var/lib/pgadmin

    depends_on:
      - postgres

# ========================================
# Development Volumes
# ========================================
volumes:
  pgadmin_data:
    driver: local

# ========================================
# Docker Compose - Development Override (Windows)
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.windows.yml up
# ========================================
# Windows Docker Desktop does not support network_mode: host.
# This file uses standard bridge networking with port mappings instead.
# Note: 'version' field is obsolete in modern Docker Compose

services:
  # ========================================
  # PostgreSQL - Development Configuration
  # ========================================
  postgres:
    environment:
      # Development: UTF-8 encoding (locale handled by Alpine defaults)
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"

  # ========================================
  # Backend - Development Configuration
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      shm_size: '256m'

    environment:
      # Development Profile
      SPRING_PROFILES_ACTIVE: dev

      # Database: Use Docker service name (bridge networking)
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/antipanel?sslmode=disable
      SPRING_DATASOURCE_USERNAME: antipanel_user
      SPRING_DATASOURCE_PASSWORD: antipanel_password

      # Development: Enable debug logging
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_ANTIPANEL: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: DEBUG
      LOGGING_LEVEL_ORG_HIBERNATE_SQL: DEBUG
      LOGGING_LEVEL_ORG_HIBERNATE_TYPE_DESCRIPTOR_SQL_BASICBINDER: TRACE

      # Development: Show SQL queries
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "true"

      # Development: Auto-update schema to match entities (prevents missing column errors)
      SPRING_JPA_HIBERNATE_DDL_AUTO: update

      # Development: Auto-reload support (requires spring-boot-devtools)
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"

      # Development: CORS enabled for Angular frontend
      APP_CORS_ALLOWED_ORIGINS: "http://localhost:4200,http://localhost:3000"

      # Development: Actuator endpoints
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "*"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always

      # Development: Add debug JVM options
      JAVA_OPTS: >-
        -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
        -XX:+UseContainerSupport
        -XX:MaxRAMPercentage=75.0
        -XX:+UseG1GC
        -Dspring.profiles.active=dev

    # Development: Mount logs volume
    volumes:
      - ./backend/logs:/app/logs

  # ========================================
  # Angular 21 Frontend - Development (Bun)
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
      shm_size: '256m'

    container_name: antipanel-frontend
    restart: unless-stopped

    ports:
      - "4200:4200"

    networks:
      - antipanel-network

    environment:
      # Development environment
      NODE_ENV: development
      # Enable polling for file changes (Docker volume compatibility)
      WATCHPACK_POLLING: "true"
      CHOKIDAR_USEPOLLING: "true"

    volumes:
      # Hot reload - mount source code
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/angular.json:/app/angular.json
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/package.json:/app/package.json
      # Prevent node_modules from being overwritten by host mount
      - /app/node_modules
      - /app/.angular
      # Docker-specific proxy config (targets backend by service name)
      - ./frontend/proxy.conf.docker.json:/app/proxy.conf.json

    depends_on:
      - backend

  # ========================================
  # pgAdmin - Database Management Tool (Optional)
  # ========================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: antipanel-pgadmin
    restart: unless-stopped

    ports:
      - "5050:5050"

    networks:
      - antipanel-network

    environment:
      # Use .com domain since .local is rejected by newer pgAdmin email validation
      PGADMIN_DEFAULT_EMAIL: admin@antipanel.dev
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: "False"
      # Set listen port since default 80 may conflict
      PGADMIN_LISTEN_PORT: 5050

    volumes:
      - pgadmin_data:/var/lib/pgadmin

    depends_on:
      - postgres

# ========================================
# Development Volumes
# ========================================
volumes:
  pgadmin_data:
    driver: local
